# 需求分析

1. 未注册用户可以参与投票，注册用户可发起投票，也可参与投票
2. 发布投票之后生成二维码，投票人扫码进入投票界面
3. 用户在注册之后可以发起投票，设置投票的相关信息，包括计票方式，投票截止时间等
4. 实时显示每个项目投票的进度，投票剩余时间
5. 投票之后由投票发起人提起计票请求，并向客户端发送投票结果

# 技术选型

基础：Springboot、Vue

- MySQL：持久化保存注册用户信息、已发起投票信息，投票选项信息等
- Redis：
    - 查询缓存，用于减轻MySQL查询压力
    - 临时计票，用于客户端实时显示进度
    - 用户注册时用于临时保存用户验证码
    - 保存已登陆用户信息（限注册用户）
    - 保存所有参与投票的用户，用户记录用户剩余票数（只保留UUID和剩余票数）
- RabbitMQ：用户投票核心功的实现（可选、可以用Redis代替）
- WebStock：用于实时回传投票进度等信息

# 执行流程

## 参与投票

用户通过扫码进入投票 => （签发UUID） => 点击投票 => (消息入队)  => 等待计票结果

## 发起投票

进入首页 => 进入注册页面完成注册 => 填写投票项目相关信息 => 生成投票通道二维码 => 等待投票终止发起计票请求 => 服务端完成计票，回传计票结果

# 详细设计

## 用户模块

- 注册/登陆（投票发起人）：用户使用手机号+验证码方式登陆，不设置密码
    - 不单独进行注册，在登陆时对手机号进行认证，同时完成注册登陆
    - 已经注册的用户使用jjwt签发token，用户后续发起计票请求的认证

- 访客（投票人）：在第一次请求服务器时，在服务端生成64位UUID，下发客户端

## 发起投票模块

> 完成注册的用户前往个人中心，通过个人中心，填写并提交表单后，服务器对表单信息校验，无误后写入数据库，并返回投票通道唯一链接。

### 表单内容

- 标题、简介
- 投票时间
    - 定时开启，定时结束
    - 立即开始，定时结束
- 投票项目列表（可异步设置）
    - 图片
    - 标题
    - 描述
- 获胜人数
- 每人拥有的选票数量

### 流程

1. 表单提交服务器
2. 服务器将信息写入数据库
3. 创建对应定时任务，定时任务到时，开启投票服务

## 计票模块

### 投票进行时计票

- 从数据库中获取当前投票活动没人最多有多少张选票
- 用户通过二维码进入投票页之后，在Redis中创建Key：UUID，Value：剩余票数
- 用户每投一票，Redis中票数减一
- Redis中创建模块为投票ID，Key：投票项目ID，Value：当前票数
- 向RabbitMQ生产消息，包含投票项目ID，所选项目ID，用户UUID

### 投票结束时计票

- 从Redis中获取投票项目相关信息，写入数据库
- 从RabbitMQ中消费消息，仅消费当前投票项目ID的消息，不消费其他消息，消费完成发送回执
- 将计票结果写入数据库
- 向客户端发送结果，结果应该来自RabbitMQ，Redis中数据仅用户数据实时显示，不能作为最终结果

# 数据库设计

## ER图设计

![image-20221002153310709](https://typora-1308549476.cos.ap-nanjing.myqcloud.com/img/image-20221002153310709.png)

# 接口示例

- 错误响应示例

```json
{
    "code": 500,
    "msg": "error",
    "data": "服务器发生错误，请联系管理员",
    "timestamp": "2022-10-05 11:50:56"
}
```

- 参数校验错误示例

```json
{
    "code": 501,
    "msg": "请求参数格式错误",
    "data": "",
    "timestamp": "2022-10-05 11:50:56"
}
```



## 获取验证码

> 接口定义：用于登陆或注册前发送验证码验证身份

| 请求路径  | 请求参数            | 参数类型 | 请求方式 |
| --------- | ------------------- | -------- | -------- |
| /api/code | phone:"13478762345" | FormData | POST     |

- 成功响应示例

```json
{
    "code": 200,
    "msg": "success",
    "data": "发送成功",
    "timestamp": "2022-10-05 11:50:56"
}
```

- 失败响应示例

```json
{
    "code": 301,
    "msg": "验证码已经发送，请稍后重试",
    "data": "",
    "timestamp": "2022-10-05 11:50:56"
}
```

## 登陆/注册

> 接口定义：如果手机号已经注册，直接登陆；如果手机号没有注册，注册并登陆，final返回用户信息

| 请求路径  | 请求参数                      | 参数类型 | 请求方式 |
| --------- | ----------------------------- | -------- | -------- |
| /api/signup | phone:"13478762345" | FormData | POST    |
|  | code:"123456" | FormData |  |


- 成功响应示例

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "uuid":"uuid(64位)",
        "phone":"12376453762",
        "regTime":"2021-12-21 12:09:00",
        "token":"token str"
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

- 失败响应示例

```json
{
    "code": 401,
    "msg": "验证码错误，或已过期",
    "data": "",
    "timestamp": "2022-10-05 11:50:56"
}
```

## 获取正在进行的投票

> 接口定义：返回当前正在进行的投票详细信息，检查当前投票人是否有uuid，没有则分配uuid

| 请求路径      | 请求参数            | 参数类型 | 请求方式 |
| ------------- | ------------------- | -------- | -------- |
| /api/vote/get | identify:uuid(64位) | header   | GET      |

- 成功响应示例

1. 当前无正在进行的投票，当前用户已有uuid

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "uuid":"-1"
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

2. 当前无正在进行的投票，当前用户无uuid

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "uuid":"uuid（64位）"
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

3. 当前投票，用户无uuid

status指明投票状态，可以投票open，投票已经截止close

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "uuid":"uuid（64位）",
        "projectId":"hgSd23",
        "title":"XX投票",
        "describe":"这是关于。。。的投票",
        "startTime":"2021-10-20 2001:01:01",
        "endTime":"2021-10-20 2001:01:01",
        "wayWin":3,
        "votingNumber":"5",
        "status":"open"
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

4. 当前投票，用户有uuid

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "uuid":"-1",
        "projectId":"hgSd23",
        "title":"XX投票",
        "describe":"这是关于。。。的投票",
        "startTime":"2021-10-20 2001:01:01",
        "endTime":"2021-10-20 2001:01:01",
		"wayWin":2,
        "votingNumber":"5",
		"status":"close"
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

## 获投票的具体项目

> 接口定义：获取某一个投票项目可以投的条目，及已投票数

| 请求路径                   | 请求参数            | 参数类型 | 请求方式 |
| -------------------------- | ------------------- | -------- | -------- |
| /api/vote/items/:projectId | identify:uuid(64位) | header   | GET      |
|                            | projectId:"dsfdf"   | path     |          |

此接口同`获取正在进行的投票`一致，需检查header中是否携带uuid，如果没有应分配uuid，如果有uuid字段返回-1(string)

- 成功响应示例

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "uuid":"-1",
        "projectId":"2fhudf",
        "items": [
            {
		        "itemsId":"1",
        		"name":"投票项名称",
		        "intrudiction":"投票项简介",
        		"img":"投票项图片url",
		        "currentVotes":234
            },
            {
		        "itemsId":"2",
        		"name":"投票项名称3",
		        "intrudiction":"投票项简介3",
        		"img":"投票项图片url3",
		        "currentVotes":57
            },
        ]
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

- 失败响应示例

```json
{
    "code": 401,
    "msg": "当前投票已经结束",
    "data": "",
    "timestamp": "2022-10-05 11:50:56"
}
```

## 投票

> 接口定义：用户投票

| 请求路径         | 请求参数               | 参数类型 | 请求方式 |
| ---------------- | ---------------------- | -------- | -------- |
| /api/vote/voting | identify:uuid(64位)    | header   | POST     |
|                  | projectId:"dsfsdfsf"   | Json     |          |
|                  | itemsId:["2","1","10"] | Json     |          |

- 请求示例

```json
{
    "projectId":"dsfsdfsf",
    items:["1","2","3"]
}
```



- 成功响应示例

返回剩余票数

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "lastVotes":3
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

- 错误响应示例

```json
{
    "code": 601,
    "msg": "没有可用票数",
    "data": "",
    "timestamp": "2022-10-05 11:50:56"
}
```

```json
{
    "code": 601,
    "msg": "当前投票已经结束",
    "data": "",
    "timestamp": "2022-10-05 11:50:56"
}
```

## 获取投票结果

> 接口定义：获取投票项目的结果

| 请求路径               | 请求参数  | 参数类型 | 请求方式 |
| ---------------------- | --------- | -------- | -------- |
| /api/result/:projectId | projectId | Path     | GET      |

```json
{
    "code": 200,
    "msg": "success",
    "data": {
        "projectId":"2fhudf",
        "title":"XX投票",
        "describe":"这是关于。。。的投票",
        "startTime":"2021-10-20 2001:01:01",
        "endTime":"2021-10-20 2001:01:01",
        "wayWin":"获胜方式",
        "status":"close",
        "items": [
            {
		        "itemsId":"1",
        		"name":"投票项名称",
		        "intrudiction":"投票项简介",
        		"img":"投票项图片url",
		        "votes":234,
                "restlt":"win"
            },
            {
		        "itemsId":"1",
        		"name":"投票项名称",
		        "intrudiction":"投票项简介",
        		"img":"投票项图片url",
		        "votes":242,
                "restlt":"lose"
            },
            {
		        "itemsId":"1",
        		"name":"投票项名称",
		        "intrudiction":"投票项简介",
        		"img":"投票项图片url",
		        "votes":123,
                "restlt":"lose"
            },
        ]
    },
    "timestamp": "2022-10-05 11:50:56"
}
```

## 发布投票项目

> 接口定义：登陆的用户发布投票项目

| 请求路径           | 请求参数      | 参数类型 | 请求方式 |
| ------------------ | ------------- | -------- | -------- |
| /api/admin/publish | Token         | Header   | POST     |
|                    | pubslihParams | Json     |          |

- 请求数据示例

```json
{
	"title":"投票名称",
    "describe":"投票描述信息",
    "startTime":"2001-10-10 20:01:01",
    "endTime":"2001-10-10 20:01:01",
    "wayWin":3,
    "votingNumber":3,
    items:[
        {
            "name":"投票项名称",
		    "intrudiction":"投票项简介",
        	"img":"投票项图片url",
        },
        {
            "name":"投票项名称",
		    "intrudiction":"投票项简介",
        	"img":"投票项图片url",
        },
        {
            "name":"投票项名称",
		    "intrudiction":"投票项简介",
        	"img":"投票项图片url",
        },
        {
            "name":"投票项名称",
		    "intrudiction":"投票项简介",
        	"img":"投票项图片url",
        }
    ]
}
```

## 上传图片

> 接口定义：用与注册用户发布投票时，上传投票项目图片

| 请求路径          | 请求参数 | 参数类型 | 请求方式 |
| ----------------- | -------- | -------- | -------- |
| /api/admin/upload | Token    | Header   | POST     |
|                   | img      | FormData |          |

- 成功响应示例

```json
{
    "code": 200,
    "msg": "success",
    "data": "图片url",
    "timestamp": "2022-10-05 11:50:56"
}
```

